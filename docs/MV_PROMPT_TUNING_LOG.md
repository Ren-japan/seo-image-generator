# MV画像生成 プロンプトチューニングログ

## 概要
MV（メインビジュアル/アイキャッチ）画像の生成品質を55点→80点超に引き上げた改善記録。
参照画像5枚ありの条件（JMROサイト）でテスト。

## テスト条件
- **サイト**: JMRO (https://jmro.co.jp/mypicks/)
- **参照画像**: 5枚 (940×705, 4:3比率)
- **モデル**: gemini-2.0-flash-exp (imagen3)
- **テンプレート**: `MV_GENERATION_WITH_REF_TEMPLATE`（参照画像あり・手動仕様書なし）
- **サイトカラー**: primary=#1c5393, accent=#ff6343

## 参照画像の共通パターン（分析結果）
- 背景: 白ベース + 淡い曲線グラデーション装飾
- テキスト: 超大きい太字、白抜き+ブルー縁取り+黒外縁
- サブタイトル: オレンジ/赤アクセントカラー
- 帯: 角丸ボックス型（白背景+影）、全幅帯ではない
- 人物: 右側に大きく配置（高さ70-80%）、切り抜き風、右端に接する
- 補足テキスト: 柔らかい濃色（真っ黒ではない）

---

## Trial 1: 2行「模倣」プロンプト — 55点

### プロンプト概要
```
添付の参照画像のデザインを模倣して、テキスト内容と人物だけを差し替えてください。
テキストは日本語のみ。
```

### 結果
- ❌ 背景がネイビーグラデーション（参照は白ベース）
- ❌ 人物が小さい
- ❌ テキストが左65%に閉じ込められすぎ
- ❌ 帯が全幅の四角形

### 学び
- 「模倣して」だけでは曖昧すぎる
- Geminiは参照画像の「サイズ関係」「色のトーン」を読み取るのが苦手

---

## Trial 2: 3000文字 Gemini分析結果注入 — 58点

### プロンプト概要
Geminiの自動分析結果（mv_ref_image_analysis、約3000文字）をそのままプロンプトに注入。
位置%、サイズ%、色HEXコード、装飾詳細を全て含む。

### 結果
- ❌ 前半の指示しか反映されない
- ❌ 後半の詳細が無視される
- △ 背景が少し明るくなった

### 学び
- **画像生成モデルは長いプロンプトの後半を無視する傾向がある**
- 3000文字は明らかに長すぎる
- テキストの質より量が問題

---

## Trial 3: 5ポイント的確補強 — 65点

### プロンプト概要
参照画像で伝わりにくい5つのポイントだけを補強:
1. 人物サイズ（80%以上）
2. 人物の右端切れ
3. 足元が下端に接する
4. テキストが人物の前面
5. 背景は白ベース

### 結果
- ✅ 背景が白ベースに改善！
- ✅ 背景装飾（曲線）が再現された
- △ 人物はまだ小さめ
- △ テキストと人物の重なりが不十分

### 学び
- **短い的確な補強が効く**
- 「モデルが苦手なこと」だけを明示的に指示する戦略が有効
- 人物サイズは「80%」と数値指定しても、まだ足りない

---

## Trial 4: 人物描画強化（16:9） — 72点

### プロンプト概要
Trial 3ベースに人物描画を大幅強化:
- 「はみ出すほど大きく」追加
- 「人物の後ろには何も描かない」追加
- テキスト-人物重なりを明示

### 結果
- ✅ 人物が大きくなった！テキストとの重なりOK
- ✅ 人物の右端切れが実現
- ❌ **背景装飾が消えた**（曲線やグラデーションが全部消えた）

### 学び
- **「人物の後ろには何も描かない」が広すぎて背景装飾まで消した**
- 「人物の背景」と「画像全体の背景装飾」を分離して指示する必要がある
- 意図しない副作用に注意

---

## Trial 5: 背景修復 + アスペクト比修正（4:3） — 75点

### プロンプト概要
2つの修正:
1. **背景指示の分離**:
   - 「人物の背後に壁・窓・家具・床の線は描かない」（人物限定）
   - 「白ベースに、参照画像にある淡い曲線やグラデーション装飾も再現する」（背景全体）
2. **アスペクト比を4:3に変更**（参照画像が940×705 = 4:3だったため）

### 結果
- ✅ 背景装飾が復活！
- ✅ 人物は大きいまま維持
- ✅ アスペクト比が参照と一致してレイアウトが自然に
- △ テキストの色がJMRO固有（赤/オレンジ指定がハードコード）
- △ 補足テキストが真っ黒で浮いている

### 学び
- **アスペクト比は参照画像と一致させるのが重要**（レイアウト再現に直結）
- 「何を描かないか」の指示は範囲を明確に限定する
- 背景装飾と人物背景は別概念として指示する

---

## Trial 6: 汎用化 + テキスト色改善 + 正確性強化 — 80点超 🎉

### プロンプト変更（3つの改善）

#### 1. スタイル指定の汎用化（JMRO固有→参照画像ベース）
```
Before: 「{subtitle}」→ 赤/オレンジ太字
After:  「{subtitle}」→ 参照画像のサブタイトルと同じ色・サイズ・装飾

Before: 「{band_text}」→ 白い角丸ボックス内
After:  「{band_text}」→ 参照画像と同じスタイルのボックス内（色・角丸・影も同じに）
```
**理由**: ハードコードした色・スタイルがGeminiの参照画像認識と矛盾→「参照画像と同じ」にすることで矛盾を解消

#### 2. テキスト色の改善
```
- 補足テキスト: 「真っ黒#000は避け、#333〜#444の柔らかい濃色」
- _build_mv_color_instruction(): text_color=#000000の場合、自動で#333333に置き換え
- 「真っ黒#000は避け」の注記を追加
```
**理由**: 純黒テキストが背景に対して浮いて見える→わずかに彩度を落とすことで馴染む

#### 3. テキスト正確性の強化
```
追加: 「上記「」内の文字列を一字一句そのまま描画すること。文言を変えたり省略したり追加しない。」
```
**理由**: Geminiが指定テキストを勝手に変えることがあった（例:「SNSで話題！」→「今話題の」）

### 結果（3案全て生成）
- ✅ 背景: 白ベース + 淡い曲線装飾 → 参照画像にかなり近い
- ✅ テキストスタイル: BAKUNE太字+縁取り、サブタイトルの色 → 参照に近い
- ✅ 帯/ボックス: 角丸スタイル → 参照に近い
- ✅ 補足テキスト: 柔らかい濃色 → 自然に馴染む
- ✅ アスペクト比4:3 → レイアウトが安定
- ✅ **3案とも安定して高品質**（再現性あり）
- △ 人物がソファに座っている場合がある（参照は立ち姿切り抜き）→ person_descriptionの問題

### 学び
- **「参照画像と同じ」は最強の汎用指示** — 具体的な色やスタイルを書くより、参照画像を信頼する方がいい
- テンプレートにサイト固有の値をハードコードしない
- テキスト色は#000よりも#333〜#444の方がデザイン的に馴染む
- テキスト正確性は明示的に指示しないとモデルが勝手に変える

---

## 最終テンプレート（Trial 6時点）

```python
MV_GENERATION_WITH_REF_TEMPLATE = """添付の参照画像のデザインを完全にコピーして、テキスト内容と人物だけを差し替えてください。

{color_instruction}

== 最重要: 人物の描き方（参照画像を見て確認すること） ==
- 人物は画像の右側に配置し、画像の高さの80%以上を占める大きさにする
- 人物の右腕や右肩は画像の右端で切れてよい（はみ出すほど大きく）
- 人物の足元は画像の下端に接する
- 人物の背後に壁・窓・家具・床の線は描かない。人物は切り抜き写真のように背景と直接溶け込む
- テキストは人物の前面に重ねて表示する（人物がテキストの後ろにいる）

== 背景（参照画像と同じように） ==
- 白ベースに、参照画像にある淡い曲線やグラデーション装飾も再現する

== テキスト（参照画像と同じサイズ・装飾・色で。文字列は一字一句正確に） ==
- 「{hook_text}」→ 左上の小さい角丸ラベル（参照画像と同じスタイル）
- 「{main_title}」→ 画面の半分を占める超巨大太字（参照画像と同じ縁取り・装飾）
- 「{subtitle}」→ 参照画像のサブタイトルと同じ色・サイズ・装飾
- 「{band_text}」→ 参照画像と同じスタイルのボックス内（色・角丸・影も同じに）
- 「{supplement_text}」→ 下部の小さい文字（真っ黒#000は避け、#333〜#444の柔らかい濃色）
- 人物: {person_description}

重要: 上記「」内の文字列を一字一句そのまま描画すること。文言を変えたり省略したり追加しない。
テキストは{language}のみ。
"""
```

---

## Trial 7: 全サイト汎用化（テラクリック検証） — テスト中

### 問題発生
Trial 6のテンプレートをテラクリック（美容医療サイト、ネイビー/ゴールド系デザイン）で使用したところ、
**参照画像のスタイルが全く反映されない**。

### 原因分析
Trial 6のテンプレートに**JMRO固有の前提が3箇所ハードコード**されていた:

1. **背景**: `白ベースに、参照画像にある淡い曲線やグラデーション装飾も再現する`
   - テラクリックはネイビー/ブルーグレー系の背景 → 白ベース指示が矛盾
2. **人物**: `右側に配置、高さ80%以上、右端切れ、足元下端接触`
   - テラクリックの参照画像の人物配置は異なる可能性
3. **テキスト色**: `真っ黒#000は避け、#333〜#444の柔らかい濃色`
   - ダーク背景サイトでは白テキストかもしれない → 決め打ちNG

**根本**: Trial 6の「参照画像と同じ」戦略は正しかったが、背景・人物・テキスト色の3箇所だけJMRO固有の値が残っていて、それがGeminiの参照画像読み取りを上書きしてしまった。

### 修正内容

#### 1. テンプレート: サイト固有の仮定を完全排除
```
Before: - 人物は画像の右側に配置し、画像の高さの80%以上を占める大きさにする
After:  - 人物の位置・サイズ・ポーズは参照画像と同じにする

Before: - 白ベースに、参照画像にある淡い曲線やグラデーション装飾も再現する
After:  - 参照画像と同じ背景スタイルを再現する（色調・グラデーション・装飾パターン全て）

Before: - 「{supplement_text}」→ 下部の小さい文字（真っ黒#000は避け、#333〜#444の柔らかい濃色）
After:  - 「{supplement_text}」→ 参照画像の補足テキストと同じスタイル
```

#### 2. 配色指示: 「サイトカラー優先」→「参照画像優先」に反転
```
Before: 以下のサイトカラーパレットを基調として配色すること（デザイン仕様書内の色指定より優先）
After:  参照画像の配色トーンに従いつつ、以下のサイトカラーを参考にすること
        参照画像の配色が上記と異なる場合は、参照画像の配色を優先すること
```

### 学び
- **「参照画像と同じ」は徹底しないと意味がない** — 1箇所でもハードコードが残ると、そこが参照画像を上書きする
- **サイトカラーは「参考値」** — 参照画像に実際のスタイルが入っているなら、カラーパレットは補助情報に格下げすべき
- **汎用テンプレートに固有値を入れない** — JMROで成功した値でも、テラクリックでは害になる

---

## Trial 8: フォント統一指示追加 — 回帰発生 ❌

### プロンプト変更
Trial 7ベースに「フォント統一」セクションを追加:
```
== フォント統一（厳守） ==
- 画像内の全テキスト要素は参照画像と同じフォントファミリー・ウェイトで統一すること
- 上半分と下半分でフォントの種類やウェイトが変わってはいけない
```
初回は「太字ゴシック体」とハードコードしたが、汎用性に反するため「参照画像と同じフォントファミリー・ウェイト」に修正。

### 結果（テラクリックでテスト）
- ❌ **配色が完全に壊れた** — ピンク/ローズゴールド系になり、参照画像のネイビー/ブルーグレーと全く異なる
- ❌ 金色の装飾フレームが追加された
- ❌ サイトのブランドカラーが完全無視

### 原因分析
テラクリックの参照画像4枚を確認:
1. `futae-downtime-mv.webp` — 白ベース+ブルーグレー系 ✅
2. `futae-nebusoku-mv.webp` — 白ベース+ブルーグレー系 ✅
3. `futae-sapporo-mv.webp` — 写真背景+ブルー系 ✅
4. `futae-success_mv.webp` — **ピンク/ローズ系** ❌

**4枚中1枚だけ異なるトーン**。Trial 7/8のテンプレートは「参照画像の配色が最優先」→ Geminiがピンク画像を拾うとサイトカラー(ネイビー)を無視してピンクで生成してしまう。

### 学び
- **参照画像のトーンがバラバラだと「参照画像優先」は危険** — モデルがどれを正解と見るか不安定
- **サイトカラーは「参考値」ではなく「アンカー」にすべき** — 配色のブレを防ぐ基準点として機能させる
- **フォント統一指示自体は問題なかった** — 回帰の本質は配色優先度の設計ミス

---

## Trial 9: 配色アンカー戦略 — テスト中

### 問題の本質
「参照画像の配色を最優先」は参照画像が統一されたトーンの時だけ有効。
トーンがバラバラな場合、モデルがランダムに1枚を拾って配色が不安定になる。

### 修正内容

#### 1. テンプレート: 「完全コピー」→「参考にして」+ 共通パターン戦略
```
Before: 添付の参照画像のデザインを完全にコピーして
After:  添付の参照画像のデザインを参考にして

追加:
== 参照画像が複数ある場合のルール ==
- 複数の参照画像に共通するレイアウトパターン・装飾スタイルを採用すること
- 配色は上記のサイトカラーパレットを基準とし、参照画像の中でサイトカラーに近いトーンのものを優先的に参考にすること
- 1枚だけ異なるトーンの画像がある場合、それは例外として無視する
```
**理由**: 参照画像への依存度を下げ、サイトカラーで配色をアンカリングする

#### 2. 配色指示: 「参照画像優先」→「サイトカラーが基準」
```
Before: == 配色の参考情報（参照画像の配色が最優先） ==
        参照画像の配色トーンに従いつつ、以下のサイトカラーを参考にすること:
        ...
        - 参照画像の配色が上記と異なる場合は、参照画像の配色を優先すること

After:  == 配色パレット（このサイトのブランドカラー。配色の基準として使うこと） ==
        ...
        - 上記カラーパレットのトーンに合った配色で画像全体を統一すること
```
**理由**: サイトカラーを「参考値」から「基準」に格上げ。ピンク画像を拾っても、サイトカラー(ネイビー)が基準なので引きずられない

#### 3. 背景指示: サイトカラー基調を明示
```
Before: 参照画像と同じ背景スタイルを再現する（色調・グラデーション・装飾パターン全て）
After:  参照画像の共通パターンに合わせた背景スタイルにする（色調・装飾パターン）
        背景色はサイトカラーパレットのテーマカラーを基調とする
```

### 期待される効果
- テラ: primary=#38506b(ネイビー) → ネイビー系で安定。ピンク参照画像は例外として無視される
- JMRO: primary=#1c5393(ブルー) → ブルー系で安定。参照画像もブルー系なので変化なし
- 新規サイト: サイトカラーさえ正しく設定されていれば、参照画像のバリエーションに左右されない

---

## 改善の原則まとめ

1. **「参照画像と同じ」を信頼する** — 具体値のハードコードより汎用的で強い
2. **モデルが苦手なことだけ補強する** — サイズ感、人物切り抜き、テキスト正確性
3. **プロンプトは短く保つ** — 長すぎると後半が無視される
4. **「何を描かないか」は範囲を限定する** — 広すぎると副作用が出る
5. **アスペクト比は参照画像に合わせる** — レイアウト再現の前提条件
6. **色は#000より#333** — デザイン的に背景と馴染む（※ただし白ベースサイト限定）
7. **テキスト正確性は明示的に指示する** — AIは勝手にテキストを変える傾向がある
8. **サイト固有の仮定を汎用テンプレートに入れない** — 1サイトで成功した値が他サイトでは害になる
9. **サイトカラーはアンカー（基準）** — 参照画像のトーンがバラバラでもサイトカラーで配色を安定させる（Trial 9で修正。Trial 7の「参照画像優先」は参照画像が不統一な場合に破綻する）
10. **参照画像が複数ある場合は「共通パターン」を採用** — 1枚だけ異なるトーンの画像は例外として無視させる
