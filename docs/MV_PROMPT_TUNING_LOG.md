# MV画像生成 プロンプトチューニングログ

## 概要
MV（メインビジュアル/アイキャッチ）画像の生成品質を55点→80点超に引き上げた改善記録。
参照画像5枚ありの条件（JMROサイト）でテスト。

## テスト条件
- **サイト**: JMRO (https://jmro.co.jp/mypicks/)
- **参照画像**: 5枚 (940×705, 4:3比率)
- **モデル**: gemini-2.0-flash-exp (imagen3)
- **テンプレート**: `MV_GENERATION_WITH_REF_TEMPLATE`（参照画像あり・手動仕様書なし）
- **サイトカラー**: primary=#1c5393, accent=#ff6343

## 参照画像の共通パターン（分析結果）
- 背景: 白ベース + 淡い曲線グラデーション装飾
- テキスト: 超大きい太字、白抜き+ブルー縁取り+黒外縁
- サブタイトル: オレンジ/赤アクセントカラー
- 帯: 角丸ボックス型（白背景+影）、全幅帯ではない
- 人物: 右側に大きく配置（高さ70-80%）、切り抜き風、右端に接する
- 補足テキスト: 柔らかい濃色（真っ黒ではない）

---

## Trial 1: 2行「模倣」プロンプト — 55点

### プロンプト概要
```
添付の参照画像のデザインを模倣して、テキスト内容と人物だけを差し替えてください。
テキストは日本語のみ。
```

### 結果
- ❌ 背景がネイビーグラデーション（参照は白ベース）
- ❌ 人物が小さい
- ❌ テキストが左65%に閉じ込められすぎ
- ❌ 帯が全幅の四角形

### 学び
- 「模倣して」だけでは曖昧すぎる
- Geminiは参照画像の「サイズ関係」「色のトーン」を読み取るのが苦手

---

## Trial 2: 3000文字 Gemini分析結果注入 — 58点

### プロンプト概要
Geminiの自動分析結果（mv_ref_image_analysis、約3000文字）をそのままプロンプトに注入。
位置%、サイズ%、色HEXコード、装飾詳細を全て含む。

### 結果
- ❌ 前半の指示しか反映されない
- ❌ 後半の詳細が無視される
- △ 背景が少し明るくなった

### 学び
- **画像生成モデルは長いプロンプトの後半を無視する傾向がある**
- 3000文字は明らかに長すぎる
- テキストの質より量が問題

---

## Trial 3: 5ポイント的確補強 — 65点

### プロンプト概要
参照画像で伝わりにくい5つのポイントだけを補強:
1. 人物サイズ（80%以上）
2. 人物の右端切れ
3. 足元が下端に接する
4. テキストが人物の前面
5. 背景は白ベース

### 結果
- ✅ 背景が白ベースに改善！
- ✅ 背景装飾（曲線）が再現された
- △ 人物はまだ小さめ
- △ テキストと人物の重なりが不十分

### 学び
- **短い的確な補強が効く**
- 「モデルが苦手なこと」だけを明示的に指示する戦略が有効
- 人物サイズは「80%」と数値指定しても、まだ足りない

---

## Trial 4: 人物描画強化（16:9） — 72点

### プロンプト概要
Trial 3ベースに人物描画を大幅強化:
- 「はみ出すほど大きく」追加
- 「人物の後ろには何も描かない」追加
- テキスト-人物重なりを明示

### 結果
- ✅ 人物が大きくなった！テキストとの重なりOK
- ✅ 人物の右端切れが実現
- ❌ **背景装飾が消えた**（曲線やグラデーションが全部消えた）

### 学び
- **「人物の後ろには何も描かない」が広すぎて背景装飾まで消した**
- 「人物の背景」と「画像全体の背景装飾」を分離して指示する必要がある
- 意図しない副作用に注意

---

## Trial 5: 背景修復 + アスペクト比修正（4:3） — 75点

### プロンプト概要
2つの修正:
1. **背景指示の分離**:
   - 「人物の背後に壁・窓・家具・床の線は描かない」（人物限定）
   - 「白ベースに、参照画像にある淡い曲線やグラデーション装飾も再現する」（背景全体）
2. **アスペクト比を4:3に変更**（参照画像が940×705 = 4:3だったため）

### 結果
- ✅ 背景装飾が復活！
- ✅ 人物は大きいまま維持
- ✅ アスペクト比が参照と一致してレイアウトが自然に
- △ テキストの色がJMRO固有（赤/オレンジ指定がハードコード）
- △ 補足テキストが真っ黒で浮いている

### 学び
- **アスペクト比は参照画像と一致させるのが重要**（レイアウト再現に直結）
- 「何を描かないか」の指示は範囲を明確に限定する
- 背景装飾と人物背景は別概念として指示する

---

## Trial 6: 汎用化 + テキスト色改善 + 正確性強化 — 80点超 🎉

### プロンプト変更（3つの改善）

#### 1. スタイル指定の汎用化（JMRO固有→参照画像ベース）
```
Before: 「{subtitle}」→ 赤/オレンジ太字
After:  「{subtitle}」→ 参照画像のサブタイトルと同じ色・サイズ・装飾

Before: 「{band_text}」→ 白い角丸ボックス内
After:  「{band_text}」→ 参照画像と同じスタイルのボックス内（色・角丸・影も同じに）
```
**理由**: ハードコードした色・スタイルがGeminiの参照画像認識と矛盾→「参照画像と同じ」にすることで矛盾を解消

#### 2. テキスト色の改善
```
- 補足テキスト: 「真っ黒#000は避け、#333〜#444の柔らかい濃色」
- _build_mv_color_instruction(): text_color=#000000の場合、自動で#333333に置き換え
- 「真っ黒#000は避け」の注記を追加
```
**理由**: 純黒テキストが背景に対して浮いて見える→わずかに彩度を落とすことで馴染む

#### 3. テキスト正確性の強化
```
追加: 「上記「」内の文字列を一字一句そのまま描画すること。文言を変えたり省略したり追加しない。」
```
**理由**: Geminiが指定テキストを勝手に変えることがあった（例:「SNSで話題！」→「今話題の」）

### 結果（3案全て生成）
- ✅ 背景: 白ベース + 淡い曲線装飾 → 参照画像にかなり近い
- ✅ テキストスタイル: BAKUNE太字+縁取り、サブタイトルの色 → 参照に近い
- ✅ 帯/ボックス: 角丸スタイル → 参照に近い
- ✅ 補足テキスト: 柔らかい濃色 → 自然に馴染む
- ✅ アスペクト比4:3 → レイアウトが安定
- ✅ **3案とも安定して高品質**（再現性あり）
- △ 人物がソファに座っている場合がある（参照は立ち姿切り抜き）→ person_descriptionの問題

### 学び
- **「参照画像と同じ」は最強の汎用指示** — 具体的な色やスタイルを書くより、参照画像を信頼する方がいい
- テンプレートにサイト固有の値をハードコードしない
- テキスト色は#000よりも#333〜#444の方がデザイン的に馴染む
- テキスト正確性は明示的に指示しないとモデルが勝手に変える

---

## 最終テンプレート（Trial 6時点）

```python
MV_GENERATION_WITH_REF_TEMPLATE = """添付の参照画像のデザインを完全にコピーして、テキスト内容と人物だけを差し替えてください。

{color_instruction}

== 最重要: 人物の描き方（参照画像を見て確認すること） ==
- 人物は画像の右側に配置し、画像の高さの80%以上を占める大きさにする
- 人物の右腕や右肩は画像の右端で切れてよい（はみ出すほど大きく）
- 人物の足元は画像の下端に接する
- 人物の背後に壁・窓・家具・床の線は描かない。人物は切り抜き写真のように背景と直接溶け込む
- テキストは人物の前面に重ねて表示する（人物がテキストの後ろにいる）

== 背景（参照画像と同じように） ==
- 白ベースに、参照画像にある淡い曲線やグラデーション装飾も再現する

== テキスト（参照画像と同じサイズ・装飾・色で。文字列は一字一句正確に） ==
- 「{hook_text}」→ 左上の小さい角丸ラベル（参照画像と同じスタイル）
- 「{main_title}」→ 画面の半分を占める超巨大太字（参照画像と同じ縁取り・装飾）
- 「{subtitle}」→ 参照画像のサブタイトルと同じ色・サイズ・装飾
- 「{band_text}」→ 参照画像と同じスタイルのボックス内（色・角丸・影も同じに）
- 「{supplement_text}」→ 下部の小さい文字（真っ黒#000は避け、#333〜#444の柔らかい濃色）
- 人物: {person_description}

重要: 上記「」内の文字列を一字一句そのまま描画すること。文言を変えたり省略したり追加しない。
テキストは{language}のみ。
"""
```

---

## 改善の原則まとめ

1. **「参照画像と同じ」を信頼する** — 具体値のハードコードより汎用的で強い
2. **モデルが苦手なことだけ補強する** — サイズ感、人物切り抜き、テキスト正確性
3. **プロンプトは短く保つ** — 長すぎると後半が無視される
4. **「何を描かないか」は範囲を限定する** — 広すぎると副作用が出る
5. **アスペクト比は参照画像に合わせる** — レイアウト再現の前提条件
6. **色は#000より#333** — デザイン的に背景と馴染む
7. **テキスト正確性は明示的に指示する** — AIは勝手にテキストを変える傾向がある
